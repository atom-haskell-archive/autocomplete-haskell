"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const fuzzaldrin_1 = require("fuzzaldrin");
const typeScope = ['meta.type-signature.haskell'];
const sourceScope = ['source.haskell'];
const moduleScope = ['meta.import.haskell', 'support.other.module.haskell'];
const preprocessorScope = ['meta.preprocessor.haskell'];
const instancePreprocessorScope = ['meta.declaration.instance.haskell', 'meta.preprocessor.haskell'];
const exportsScope = ['meta.import.haskell', 'meta.declaration.exports.haskell'];
const pragmaWords = [
    'LANGUAGE', 'OPTIONS_GHC', 'INCLUDE', 'WARNING', 'DEPRECATED', 'INLINE',
    'NOINLINE', 'ANN', 'LINE', 'RULES', 'SPECIALIZE', 'UNPACK', 'SOURCE'
];
const instancePragmaWords = [
    'INCOHERENT',
    'OVERLAPPABLE',
    'OVERLAPPING',
    'OVERLAPS'
];
class SuggestionBuilder {
    constructor(options, backend) {
        this.options = options;
        this.backend = backend;
        this.buffer = this.options.editor.getBuffer();
        this.lineRange = new atom_1.Range([this.options.bufferPosition.row, 0], this.options.bufferPosition);
        this.line = this.buffer.getTextInRange(this.lineRange);
        this.mwl =
            this.options.activatedManually ?
                0
                :
                    atom.config.get('autocomplete-plus.minimumWordLength');
    }
    getSuggestions() {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.isIn(instancePreprocessorScope)) {
                return this.preprocessorSuggestions(instancePragmaWords);
            }
            else if (this.isIn(typeScope)) {
                return this.symbolSuggestions(this.backend.getCompletionsForType.bind(this.backend));
            }
            else if (this.isIn(moduleScope)) {
                return this.moduleSuggestions();
            }
            else if (this.isIn(exportsScope)) {
                return this.symbolSuggestions(this.backend.getCompletionsForSymbolInModule.bind(this.backend));
            }
            else if (this.isIn(preprocessorScope)) {
                return this.preprocessorSuggestions(pragmaWords);
            }
            else if (this.isIn(sourceScope)) {
                if (this.getPrefix().startsWith('_')) {
                    if (atom.config.get('autocomplete-haskell.ingoreMinimumWordLengthForHoleCompletions')) {
                        this.mwl = 1;
                    }
                    return this.symbolSuggestions(this.backend.getCompletionsForHole.bind(this.backend));
                }
                else {
                    return this.symbolSuggestions(this.backend.getCompletionsForSymbol.bind(this.backend));
                }
            }
            else {
                return [];
            }
        });
    }
    lineSearch(rx, idx = 0) {
        const match = this.line.match(rx);
        if (match) {
            return match[0];
        }
        else {
            return '';
        }
    }
    isIn(scope) {
        return scope.every((s1) => this.options.scopeDescriptor.getScopesArray().includes(s1));
    }
    getPrefix(rx) {
        if (!rx) {
            rx = /[\w.']+$/;
        }
        return this.lineSearch(rx);
    }
    buildSymbolSuggestion(s, prefix) {
        return {
            text: s.qname ? s.qname : s.name,
            rightLabel: (s.module ? s.module.name : undefined),
            type: s.symbolType,
            replacementPrefix: prefix,
            description: s.name + ' :: ' + s.typeSignature
        };
    }
    buildSimpleSuggestion(type, text, prefix, label) {
        return {
            text,
            type,
            replacementPrefix: prefix,
            rightLabel: label
        };
    }
    processSuggestions(f, rx, p) {
        return __awaiter(this, void 0, void 0, function* () {
            const prefix = this.getPrefix(rx);
            if (prefix.length < this.mwl) {
                return [];
            }
            const symbols = yield f(this.buffer, prefix, this.options.bufferPosition);
            return symbols.map((s) => p(s, prefix));
        });
    }
    symbolSuggestions(f) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.processSuggestions(f, undefined, this.buildSymbolSuggestion.bind(this));
        });
    }
    moduleSuggestions() {
        return __awaiter(this, void 0, void 0, function* () {
            return this.processSuggestions(this.backend.getCompletionsForModule.bind(this.backend), undefined, (s, prefix) => this.buildSimpleSuggestion('import', s, prefix));
        });
    }
    preprocessorSuggestions(pragmaList) {
        let f;
        const kwrx = new RegExp(`\\b(${pragmaList.join('|')})\\b`);
        const kw = this.lineSearch(kwrx);
        let label = '';
        let rx;
        switch (false) {
            case kw !== 'OPTIONS_GHC':
                rx = /[\w-]+$/;
                label = 'GHC Flag';
                f = this.backend.getCompletionsForCompilerOptions;
                break;
            case kw !== 'LANGUAGE':
                label = 'Language';
                f = this.backend.getCompletionsForLanguagePragmas;
                break;
            case !!kw:
                label = 'Pragma';
                f = (b, p) => __awaiter(this, void 0, void 0, function* () { return fuzzaldrin_1.filter(pragmaList, p); });
                break;
            default:
                return [];
        }
        return this.processSuggestions(f, rx, (s, prefix) => this.buildSimpleSuggestion('keyword', s, prefix, label));
    }
}
exports.SuggestionBuilder = SuggestionBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3VnZ2VzdGlvbi1idWlsZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3N1Z2dlc3Rpb24tYnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsK0JBQTBCO0FBQzFCLDJDQUFpQztBQUdqQyxNQUFNLFNBQVMsR0FBRyxDQUFDLDZCQUE2QixDQUFDLENBQUE7QUFDakQsTUFBTSxXQUFXLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO0FBQ3RDLE1BQU0sV0FBVyxHQUFHLENBQUMscUJBQXFCLEVBQUUsOEJBQThCLENBQUMsQ0FBQTtBQUMzRSxNQUFNLGlCQUFpQixHQUFHLENBQUMsMkJBQTJCLENBQUMsQ0FBQTtBQUN2RCxNQUFNLHlCQUF5QixHQUFHLENBQUMsbUNBQW1DLEVBQUUsMkJBQTJCLENBQUMsQ0FBQTtBQUNwRyxNQUFNLFlBQVksR0FBRyxDQUFDLHFCQUFxQixFQUFFLGtDQUFrQyxDQUFDLENBQUE7QUFFaEYsTUFBTSxXQUFXLEdBQUc7SUFDbEIsVUFBVSxFQUFFLGFBQWEsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxRQUFRO0lBQ3ZFLFVBQVUsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLFFBQVE7Q0FDckUsQ0FBQTtBQUVELE1BQU0sbUJBQW1CLEdBQUc7SUFDMUIsWUFBWTtJQUNaLGNBQWM7SUFDZCxhQUFhO0lBQ2IsVUFBVTtDQUNYLENBQUE7QUFtQkQ7SUFLRSxZQUFxQixPQUFpQixFQUFVLE9BQTJCO1FBQXRELFlBQU8sR0FBUCxPQUFPLENBQVU7UUFBVSxZQUFPLEdBQVAsT0FBTyxDQUFvQjtRQUN6RSxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFBO1FBQzdDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxZQUFLLENBQ3hCLENBQUMs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QUFDLENBQUMsQ0FBQTtJQUM1RCxDQUFDO0NBQ0Y7QUFuSUQsOENBbUlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtSYW5nZX0gZnJvbSAnYXRvbSdcbmltcG9ydCB7ZmlsdGVyfSBmcm9tICdmdXp6YWxkcmluJ1xuaW1wb3J0IHtJQ29tcGxldGlvbkJhY2tlbmQsIElTeW1ib2wsIFN5bWJvbFR5cGV9IGZyb20gJy4uL3R5cGluZ3MvY29tcGxldGlvbi1iYWNrZW5kJ1xuXG5jb25zdCB0eXBlU2NvcGUgPSBbJ21ldGEudHlwZS1zaWduYXR1cmUuaGFza2VsbCddXG5jb25zdCBzb3VyY2VTY29wZSA9IFsnc291cmNlLmhhc2tlbGwnXVxuY29uc3QgbW9kdWxlU2NvcGUgPSBbJ21ldGEuaW1wb3J0Lmhhc2tlbGwnLCAnc3VwcG9ydC5vdGhlci5tb2R1bGUuaGFza2VsbCddXG5jb25zdCBwcmVwcm9jZXNzb3JTY29wZSA9IFsnbWV0YS5wcmVwcm9jZXNzb3IuaGFza2VsbCddXG5jb25zdCBpbnN0YW5jZVByZXByb2Nlc3NvclNjb3BlID0gWydtZXRhLmRlY2xhcmF0aW9uLmluc3RhbmNlLmhhc2tlbGwnLCAnbWV0YS5wcmVwcm9jZXNzb3IuaGFza2VsbCddXG5jb25zdCBleHBvcnRzU2NvcGUgPSBbJ21ldGEuaW1wb3J0Lmhhc2tlbGwnLCAnbWV0YS5kZWNsYXJhdGlvbi5leHBvcnRzLmhhc2tlbGwnXVxuXG5jb25zdCBwcmFnbWFXb3JkcyA9IFtcbiAgJ0xBTkdVQUdFJywgJ09QVElPTlNfR0hDJywgJ0lOQ0xVREUnLCAnV0FSTklORycsICdERVBSRUNBVEVEJywgJ0lOTElORScsXG4gICdOT0lOTElORScsICdBTk4nLCAnTElORScsICdSVUxFUycsICdTUEVDSUFMSVpFJywgJ1VOUEFDSycsICdTT1VSQ0UnXG5dXG5cbmNvbnN0IGluc3RhbmNlUHJhZ21hV29yZHMgPSBbXG4gICdJTkNPSEVSRU5UJyxcbiAgJ09WRVJMQVBQQUJMRScsXG4gICdPVkVSTEFQUElORycsXG4gICdPVkVSTEFQUydcbl1cblxuZXhwb3J0IGludGVyZmFjZSBJT3B0aW9ucyB7XG4gIGVkaXRvcjogQXRvbVR5cGVzLlRleHRFZGl0b3JcbiAgYnVmZmVyUG9zaXRpb246IEF0b21UeXBlcy5Qb2ludFxuICBhY3RpdmF0ZWRNYW51YWxseTogYm9vbGVhblxuICBzY29wZURlc2NyaXB0b3I6IEF0b21UeXBlcy5TY29wZURlc2NyaXB0b3Jcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJU3VnZ2VzdGlvbiB7XG4gIHRleHQ6IHN0cmluZ1xuICByaWdodExhYmVsPzogc3RyaW5nXG4gIHR5cGU6IFN5bWJvbFR5cGUgfCAnaW1wb3J0JyB8ICdrZXl3b3JkJ1xuICByZXBsYWNlbWVudFByZWZpeDogc3RyaW5nXG4gIGRlc2NyaXB0aW9uPzogc3RyaW5nXG59XG5cbnR5cGUgR2V0U3ltYm9sc0NhbGxiYWNrPFQ+ID0gKGJ1ZmZlcjogQXRvbVR5cGVzLlRleHRCdWZmZXIsIHByZWZpeDogc3RyaW5nLCBwb3NpdGlvbjogQXRvbVR5cGVzLlBvaW50KSA9PiBQcm9taXNlPFRbXT5cblxuZXhwb3J0IGNsYXNzIFN1Z2dlc3Rpb25CdWlsZGVyIHtcbiAgcHJpdmF0ZSBidWZmZXI6IEF0b21UeXBlcy5UZXh0QnVmZmVyXG4gIHByaXZhdGUgbGluZVJhbmdlOiBBdG9tVHlwZXMuUmFuZ2VcbiAgcHJpdmF0ZSBsaW5lOiBzdHJpbmdcbiAgcHJpdmF0ZSBtd2w6IG51bWJlclxuICBjb25zdHJ1Y3RvciAocHJpdmF0ZSBvcHRpb25zOiBJT3B0aW9ucywgcHJpdmF0ZSBiYWNrZW5kOiBJQ29tcGxldGlvbkJhY2tlbmQpIHtcbiAgICB0aGlzLmJ1ZmZlciA9IHRoaXMub3B0aW9ucy5lZGl0b3IuZ2V0QnVmZmVyKClcbiAgICB0aGlzLmxpbmVSYW5nZSA9IG5ldyBSYW5nZShcbiAgICAgIFt0aGlzLm9wdGlvbnMuYnVmZmVyUG9zaXRpb24ucm93LCAwXSxcbiAgICAgIHRoaXMub3B0aW9ucy5idWZmZXJQb3NpdGlvblxuICAgIClcbiAgICB0aGlzLmxpbmUgPSB0aGlzLmJ1ZmZlci5nZXRUZXh0SW5SYW5nZSh0aGlzLmxpbmVSYW5nZSlcbiAgICB0aGlzLm13bCA9XG4gICAgICB0aGlzLm9wdGlvbnMuYWN0aXZhdGVkTWFudWFsbHkgP1xuICAgICAgICAwXG4gICAgICA6XG4gICAgICAgIGF0b20uY29uZmlnLmdldCgnYXV0b2NvbXBsZXRlLXBsdXMubWluaW11bVdvcmRMZW5ndGgnKVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldFN1Z2dlc3Rpb25zICgpOiBQcm9taXNlPElTdWdnZXN0aW9uW10+IHtcbiAgICBpZiAodGhpcy5pc0luKGluc3RhbmNlUHJlcHJvY2Vzc29yU2NvcGUpKSB7XG4gICAgICByZXR1cm4gdGhpcy5wcmVwcm9jZXNzb3JTdWdnZXN0aW9ucyhpbnN0YW5jZVByYWdtYVdvcmRzKVxuICAgIH0gZWxzZSBpZiAodGhpcy5pc0luKHR5cGVTY29wZSkpIHtcbiAgICAgIHJldHVybiB0aGlzLnN5bWJvbFN1Z2dlc3Rpb25zKHRoaXMuYmFja2VuZC5nZXRDb21wbGV0aW9uc0ZvclR5cGUuYmluZCh0aGlzLmJhY2tlbmQpKVxuICAgIH0gZWxzZSBpZiAodGhpcy5pc0luKG1vZHVsZVNjb3BlKSkge1xuICAgICAgcmV0dXJuIHRoaXMubW9kdWxlU3VnZ2VzdGlvbnMoKVxuICAgIH0gZWxzZSBpZiAodGhpcy5pc0luKGV4cG9ydHNTY29wZSkpIHtcbiAgICAgIHJldHVybiB0aGlzLnN5bWJvbFN1Z2dlc3Rpb25zKHRoaXMuYmFja2VuZC5nZXRDb21wbGV0aW9uc0ZvclN5bWJvbEluTW9kdWxlLmJpbmQodGhpcy5iYWNrZW5kKSlcbiAgICB9IGVsc2UgaWYgKHRoaXMuaXNJbihwcmVwcm9jZXNzb3JTY29wZSkpIHtcbiAgICAgIHJldHVybiB0aGlzLnByZXByb2Nlc3NvclN1Z2dlc3Rpb25zKHByYWdtYVdvcmRzKVxuICAgIC8vIHNob3VsZCBiZSBsYXN0IGFzIGxlYXN0IHNlcGNpYWxpemVkXG4gICAgfSBlbHNlIGlmICh0aGlzLmlzSW4oc291cmNlU2NvcGUpKSB7XG4gICAgICBpZiAodGhpcy5nZXRQcmVmaXgoKS5zdGFydHNXaXRoKCdfJykpIHtcbiAgICAgICAgaWYgKGF0b20uY29uZmlnLmdldCgnYXV0b2NvbXBsZXRlLWhhc2tlbGwuaW5nb3JlTWluaW11bVdvcmRMZW5ndGhGb3JIb2xlQ29tcGxldGlvbnMnKSkge1xuICAgICAgICAgIHRoaXMubXdsID0gMVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLnN5bWJvbFN1Z2dlc3Rpb25zKHRoaXMuYmFja2VuZC5nZXRDb21wbGV0aW9uc0ZvckhvbGUuYmluZCh0aGlzLmJhY2tlbmQpKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3ltYm9sU3VnZ2VzdGlvbnModGhpcy5iYWNrZW5kLmdldENvbXBsZXRpb25zRm9yU3ltYm9sLmJpbmQodGhpcy5iYWNrZW5kKSlcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFtdXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBsaW5lU2VhcmNoIChyeDogUmVnRXhwLCBpZHg6IG51bWJlciA9IDApIHtcbiAgICBjb25zdCBtYXRjaCA9IHRoaXMubGluZS5tYXRjaChyeClcbiAgICBpZiAobWF0Y2gpIHtcbiAgICAgIHJldHVybiBtYXRjaFswXVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gJydcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGlzSW4gKHNjb3BlOiBzdHJpbmdbXSkge1xuICAgIHJldHVybiBzY29wZS5ldmVyeSgoczEpID0+IHRoaXMub3B0aW9ucy5zY29wZURlc2NyaXB0b3IuZ2V0U2NvcGVzQXJyYXkoKS5pbmNsdWRlcyhzMSkpXG4gIH1cblxuICBwcml2YXRlIGdldFByZWZpeCAocng/OiBSZWdFeHApIHtcbiAgICBpZiAoIXJ4KSB7IHJ4ID0gL1tcXHcuJ10rJC8gfVxuICAgIHJldHVybiB0aGlzLmxpbmVTZWFyY2gocngpXG4gIH1cblxuICBwcml2YXRlIGJ1aWxkU3ltYm9sU3VnZ2VzdGlvbiAoczogSVN5bWJvbCwgcHJlZml4OiBzdHJpbmcpOiBJU3VnZ2VzdGlvbiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRleHQ6IHMucW5hbWUgPyBzLnFuYW1lIDogcy5uYW1lLFxuICAgICAgcmlnaHRMYWJlbDogKHMubW9kdWxlID8gcy5tb2R1bGUubmFtZSA6IHVuZGVmaW5lZCksXG4gICAgICB0eXBlOiBzLnN5bWJvbFR5cGUsXG4gICAgICByZXBsYWNlbWVudFByZWZpeDogcHJlZml4LFxuICAgICAgZGVzY3JpcHRpb246IHMubmFtZSArICcgOjogJyArIHMudHlwZVNpZ25hdHVyZVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRTaW1wbGVTdWdnZXN0aW9uIChcbiAgICB0eXBlOiAnaW1wb3J0JyB8ICdrZXl3b3JkJywgdGV4dDogc3RyaW5nLCBwcmVmaXg6IHN0cmluZywgbGFiZWw/OiBzdHJpbmdcbiAgKTogSVN1Z2dlc3Rpb24ge1xuICAgIHJldHVybiB7XG4gICAgICB0ZXh0LFxuICAgICAgdHlwZSxcbiAgICAgIHJlcGxhY2VtZW50UHJlZml4OiBwcmVmaXgsXG4gICAgICByaWdodExhYmVsOiBsYWJlbFxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcHJvY2Vzc1N1Z2dlc3Rpb25zPFQ+IChcbiAgICBmOiBHZXRTeW1ib2xzQ2FsbGJhY2s8VD4sIHJ4OiBSZWdFeHAgfCB1bmRlZmluZWQsIHA6IChzOiBULCBwOiBzdHJpbmcpID0+IElTdWdnZXN0aW9uXG4gICkge1xuICAgIGNvbnN0IHByZWZpeCA9IHRoaXMuZ2V0UHJlZml4KHJ4KVxuICAgIGlmIChwcmVmaXgubGVuZ3RoIDwgdGhpcy5td2wpIHtcbiAgICAgIHJldHVybiBbXVxuICAgIH1cbiAgICBjb25zdCBzeW1ib2xzID0gYXdhaXQgZih0aGlzLmJ1ZmZlciwgcHJlZml4LCB0aGlzLm9wdGlvbnMuYnVmZmVyUG9zaXRpb24pXG4gICAgcmV0dXJuIHN5bWJvbHMubWFwKChzKSA9PiBwKHMsIHByZWZpeCkpXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHN5bWJvbFN1Z2dlc3Rpb25zIChmOiBHZXRTeW1ib2xzQ2FsbGJhY2s8SVN5bWJvbD4pIHtcbiAgICByZXR1cm4gdGhpcy5wcm9jZXNzU3VnZ2VzdGlvbnMoZiwgdW5kZWZpbmVkLCB0aGlzLmJ1aWxkU3ltYm9sU3VnZ2VzdGlvbi5iaW5kKHRoaXMpKVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBtb2R1bGVTdWdnZXN0aW9ucyAoKSB7XG4gICAgcmV0dXJuIHRoaXMucHJvY2Vzc1N1Z2dlc3Rpb25zKHRoaXMuYmFja2VuZC5nZXRDb21wbGV0aW9uc0Zvck1vZHVsZS5iaW5kKHRoaXMuYmFja2VuZCksIHVuZGVmaW5lZCwgKHMsIHByZWZpeCkgPT5cbiAgICAgIHRoaXMuYnVpbGRTaW1wbGVTdWdnZXN0aW9uKCdpbXBvcnQnLCBzLCBwcmVmaXgpKVxuICB9XG5cbiAgcHJpdmF0ZSBwcmVwcm9jZXNzb3JTdWdnZXN0aW9ucyAocHJhZ21hTGlzdDogc3RyaW5nW10pIHtcbiAgICBsZXQgZjogR2V0U3ltYm9sc0NhbGxiYWNrPHN0cmluZz5cbiAgICBjb25zdCBrd3J4ID0gbmV3IFJlZ0V4cChgXFxcXGIoJHtwcmFnbWFMaXN0LmpvaW4oJ3wnKX0pXFxcXGJgKVxuICAgIGNvbnN0IGt3ID0gdGhpcy5saW5lU2VhcmNoKGt3cngpXG4gICAgbGV0IGxhYmVsID0gJydcbiAgICBsZXQgcnhcbiAgICBzd2l0Y2ggKGZhbHNlKSB7XG4gICAgICBjYXNlIGt3ICE9PSAnT1BUSU9OU19HSEMnOlxuICAgICAgICByeCA9IC9bXFx3LV0rJC9cbiAgICAgICAgbGFiZWwgPSAnR0hDIEZsYWcnXG4gICAgICAgIGYgPSB0aGlzLmJhY2tlbmQuZ2V0Q29tcGxldGlvbnNGb3JDb21waWxlck9wdGlvbnNcbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2Uga3cgIT09ICdMQU5HVUFHRSc6XG4gICAgICAgIGxhYmVsID0gJ0xhbmd1YWdlJ1xuICAgICAgICBmID0gdGhpcy5iYWNrZW5kLmdldENvbXBsZXRpb25zRm9yTGFuZ3VhZ2VQcmFnbWFzXG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlICEha3c6XG4gICAgICAgIGxhYmVsID0gJ1ByYWdtYSdcbiAgICAgICAgZiA9IGFzeW5jIChiLCBwKSA9PiBmaWx0ZXIocHJhZ21hTGlzdCwgcClcbiAgICAgICAgYnJlYWtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiBbXVxuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnByb2Nlc3NTdWdnZXN0aW9ucyhmLCByeCwgKHMsIHByZWZpeCkgPT5cbiAgICAgIHRoaXMuYnVpbGRTaW1wbGVTdWdnZXN0aW9uKCdrZXl3b3JkJywgcywgcHJlZml4LCBsYWJlbCkpXG4gIH1cbn1cbiJdfQ==