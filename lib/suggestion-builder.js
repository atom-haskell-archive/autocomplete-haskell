"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const fuzzaldrin_1 = require("fuzzaldrin");
const typeScope = ['meta.type-signature.haskell'];
const sourceScope = ['source.haskell'];
const moduleScope = ['meta.import.haskell', 'support.other.module.haskell'];
const preprocessorScope = ['meta.preprocessor.haskell'];
const instancePreprocessorScope = ['meta.declaration.instance.haskell', 'meta.preprocessor.haskell'];
const exportsScope = ['meta.import.haskell', 'meta.declaration.exports.haskell'];
const pragmaWords = [
    'LANGUAGE', 'OPTIONS_GHC', 'INCLUDE', 'WARNING', 'DEPRECATED', 'INLINE',
    'NOINLINE', 'ANN', 'LINE', 'RULES', 'SPECIALIZE', 'UNPACK', 'SOURCE'
];
const instancePragmaWords = [
    'INCOHERENT',
    'OVERLAPPABLE',
    'OVERLAPPING',
    'OVERLAPS'
];
const opertator_regex_1 = require("./opertator-regex");
class SuggestionBuilder {
    constructor(options, backend) {
        this.options = options;
        this.backend = backend;
        this.buffer = this.options.editor.getBuffer();
        this.lineRange = new atom_1.Range([this.options.bufferPosition.row, 0], this.options.bufferPosition);
        this.line = this.buffer.getTextInRange(this.lineRange);
        this.mwl =
            this.options.activatedManually ?
                0
                :
                    atom.config.get('autocomplete-plus.minimumWordLength');
    }
    getSuggestions() {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.isIn(instancePreprocessorScope)) {
                return this.preprocessorSuggestions(instancePragmaWords);
            }
            else if (this.isIn(typeScope)) {
                return this.symbolSuggestions(this.backend.getCompletionsForType.bind(this.backend));
            }
            else if (this.isIn(moduleScope)) {
                return this.moduleSuggestions();
            }
            else if (this.isIn(exportsScope)) {
                return this.symbolSuggestions(this.backend.getCompletionsForSymbolInModule.bind(this.backend));
            }
            else if (this.isIn(preprocessorScope)) {
                return this.preprocessorSuggestions(pragmaWords);
            }
            else if (this.isIn(sourceScope)) {
                if (this.getPrefix().startsWith('_')) {
                    return this.symbolSuggestions(this.backend.getCompletionsForHole.bind(this.backend));
                }
                else if (this.getPrefix() === '' && this.getPrefix(opertator_regex_1.operatorRx) !== '') {
                    return this.operatorSuggestions();
                }
                else {
                    return this.symbolSuggestions(this.backend.getCompletionsForSymbol.bind(this.backend));
                }
            }
            else {
                return [];
            }
        });
    }
    lineSearch(rx, idx = 0) {
        const match = this.line.match(rx);
        if (match) {
            return match;
        }
        else {
            return [''];
        }
    }
    isIn(scope) {
        return scope.every((s1) => this.options.scopeDescriptor.getScopesArray().includes(s1));
    }
    getPrefix(rx) {
        if (!rx) {
            rx = /[\w.']+$/;
        }
        return this.lineSearch(rx)[0];
    }
    buildSymbolSuggestion(s, prefix) {
        return {
            text: s.qname ? s.qname : s.name,
            rightLabel: (s.module ? s.module.name : undefined),
            type: s.symbolType,
            replacementPrefix: prefix,
            description: s.name + ' :: ' + s.typeSignature
        };
    }
    buildSimpleSuggestion(type, text, prefix, label) {
        return {
            text,
            type,
            replacementPrefix: prefix,
            rightLabel: label
        };
    }
    processSuggestions(f, rx, p) {
        return __awaiter(this, void 0, void 0, function* () {
            const prefix = this.getPrefix(rx);
            if (prefix.length < this.mwl) {
                return [];
            }
            const symbols = yield f(this.buffer, prefix, this.options.bufferPosition);
            return symbols.map((s) => p(s, prefix));
        });
    }
    symbolSuggestions(f, rx) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.processSuggestions(f, rx, this.buildSymbolSuggestion.bind(this));
        });
    }
    moduleSuggestions() {
        return __awaiter(this, void 0, void 0, function* () {
            return this.processSuggestions(this.backend.getCompletionsForModule.bind(this.backend), undefined, (s, prefix) => this.buildSimpleSuggestion('import', s, prefix));
        });
    }
    preprocessorSuggestions(pragmaList) {
        let f;
        const kwrx = new RegExp(`\\b(${pragmaList.join('|')})\\b`);
        const kw = this.lineSearch(kwrx)[0];
        let label = '';
        let rx;
        switch (false) {
            case kw !== 'OPTIONS_GHC':
                rx = /[\w-]+$/;
                label = 'GHC Flag';
                f = this.backend.getCompletionsForCompilerOptions;
                break;
            case kw !== 'LANGUAGE':
                label = 'Language';
                f = this.backend.getCompletionsForLanguagePragmas;
                break;
            case !!kw:
                label = 'Pragma';
                f = (b, p) => __awaiter(this, void 0, void 0, function* () { return fuzzaldrin_1.filter(pragmaList, p); });
                break;
            default:
                return [];
        }
        return this.processSuggestions(f, rx, (s, prefix) => this.buildSimpleSuggestion('keyword', s, prefix, label));
    }
    operatorSuggestions() {
        return __awaiter(this, void 0, void 0, function* () {
            const prefixMatch = this.lineSearch(opertator_regex_1.operatorRx);
            if (!prefixMatch) {
                return [];
            }
            const [mod, op] = prefixMatch.slice(1);
            if (prefixMatch[0].length < this.mwl) {
                return [];
            }
            const mkQName = (sym) => {
                const { name, qname } = sym;
                const newQName = qname.slice(0, -name.length) + name.slice(1, -1);
                return Object.assign({}, sym, { qname: newQName });
            };
            const symbols = yield this.backend.getCompletionsForSymbol(this.buffer, `${mod || ''}(${op}`, this.options.bufferPosition);
            const newSyms = symbols
                .filter(({ symbolType }) => symbolType === 'operator')
                .map(mkQName);
            const allSyms = fuzzaldrin_1.filter(symbols.concat(newSyms), prefixMatch[0], { key: 'qname' });
            return allSyms.map((s) => this.buildSymbolSuggestion(s, prefixMatch[0]));
        });
    }
}
exports.SuggestionBuilder = SuggestionBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3VnZ2VzdGlvbi1idWlsZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3N1Z2dlc3Rpb24tYnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsK0JBQTBCO0FBQzFCLDJDQUFpQztBQUdqQyxNQUFNLFNBQVMsR0FBRyxDQUFDLDZCQUE2QixDQUFDLENBQUE7QUFDakQsTUFBTSxXQUFXLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO0FBQ3RDLE1BQU0sV0FBVyxHQUFHLENBQUMscUJBQXFCLEVBQUUsOEJBQThCLENBQUMsQ0FBQTtBQUMzRSxNQUFNLGlCQUFpQixHQUFHLENBQUMsMkJBQTJCLENBQUMsQ0FBQTtBQUN2RCxNQUFNLHlCQUF5QixHQUFHLENBQUMsbUNBQW1DLEVBQUUsMkJBQTJCLENBQUMsQ0FBQTtBQUNwRyxNQUFNLFlBQVksR0FBRyxDQUFDLHFCQUFxQixFQUFFLGtDQUFrQyxDQUFDLENBQUE7QUFFaEYsTUFBTSxXQUFXLEdBQUc7SUFDbEIsVUFBVSxFQUFFLGFBQWEsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxRQUFRO0lBQ3ZFLFVBQVUsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLFFBQVE7Q0FDckUsQ0FBQTtBQUVELE1BQU0sbUJBQW1CLEdBQUc7SUFDMUIsWUFBWTtJQUNaLGNBQWM7SUFDZCxhQUFhO0lBQ2IsVUFBVTtDQUNYLENBQUE7QUFFRCx1REFBNEM7QUFtQjVDO0lBS0UsWUFBcUIsT0FBaUIsRUFBVSxPQUE4QjtRQUF6RCxZQUFPLEdBQVAsT0FBTyxDQUFVO1FBQVUsWUFBTyxHQUFQLE9BQU8sQ0FBdUI7UUFDNUUsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQTtRQUM3QyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksWUFB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Q0FBQTtZQUM1RyxNQUFNLE9BQU8sR0FDWCxPQUFPO2lCQUNOLE1BQU0sQ0FBQyxDQUFDLEVBQUMsVUFBVSxFQUFDLEtBQUssVUFBVSxLQUFLLFVBQVUsQ0FBQztpQkFDbkQsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFBO1lBQ2YsTUFBTSxPQUFPLEdBQUcsbUJBQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUMsQ0FBQyxDQUFBO1lBQy9FLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUMxRSxDQUFDO0tBQUE7Q0FDRjtBQXhKRCw4Q0F3SkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1JhbmdlfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHtmaWx0ZXJ9IGZyb20gJ2Z1enphbGRyaW4nXG5pbXBvcnQgQ0IgPSBVUEkuQ29tcGxldGlvbkJhY2tlbmRcblxuY29uc3QgdHlwZVNjb3BlID0gWydtZXRhLnR5cGUtc2lnbmF0dXJlLmhhc2tlbGwnXVxuY29uc3Qgc291cmNlU2NvcGUgPSBbJ3NvdXJjZS5oYXNrZWxsJ11cbmNvbnN0IG1vZHVsZVNjb3BlID0gWydtZXRhLmltcG9ydC5oYXNrZWxsJywgJ3N1cHBvcnQub3RoZXIubW9kdWxlLmhhc2tlbGwnXVxuY29uc3QgcHJlcHJvY2Vzc29yU2NvcGUgPSBbJ21ldGEucHJlcHJvY2Vzc29yLmhhc2tlbGwnXVxuY29uc3QgaW5zdGFuY2VQcmVwcm9jZXNzb3JTY29wZSA9IFsnbWV0YS5kZWNsYXJhdGlvbi5pbnN0YW5jZS5oYXNrZWxsJywgJ21ldGEucHJlcHJvY2Vzc29yLmhhc2tlbGwnXVxuY29uc3QgZXhwb3J0c1Njb3BlID0gWydtZXRhLmltcG9ydC5oYXNrZWxsJywgJ21ldGEuZGVjbGFyYXRpb24uZXhwb3J0cy5oYXNrZWxsJ11cblxuY29uc3QgcHJhZ21hV29yZHMgPSBbXG4gICdMQU5HVUFHRScsICdPUFRJT05TX0dIQycsICdJTkNMVURFJywgJ1dBUk5JTkcnLCAnREVQUkVDQVRFRCcsICdJTkxJTkUnLFxuICAnTk9JTkxJTkUnLCAnQU5OJywgJ0xJTkUnLCAnUlVMRVMnLCAnU1BFQ0lBTElaRScsICdVTlBBQ0snLCAnU09VUkNFJ1xuXVxuXG5jb25zdCBpbnN0YW5jZVByYWdtYVdvcmRzID0gW1xuICAnSU5DT0hFUkVOVCcsXG4gICdPVkVSTEFQUEFCTEUnLFxuICAnT1ZFUkxBUFBJTkcnLFxuICAnT1ZFUkxBUFMnXG5dXG5cbmltcG9ydCB7b3BlcmF0b3JSeH0gZnJvbSAnLi9vcGVydGF0b3ItcmVnZXgnXG5cbmV4cG9ydCBpbnRlcmZhY2UgSU9wdGlvbnMge1xuICBlZGl0b3I6IEF0b21UeXBlcy5UZXh0RWRpdG9yXG4gIGJ1ZmZlclBvc2l0aW9uOiBBdG9tVHlwZXMuUG9pbnRcbiAgYWN0aXZhdGVkTWFudWFsbHk6IGJvb2xlYW5cbiAgc2NvcGVEZXNjcmlwdG9yOiBBdG9tVHlwZXMuU2NvcGVEZXNjcmlwdG9yXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVN1Z2dlc3Rpb24ge1xuICB0ZXh0OiBzdHJpbmdcbiAgcmlnaHRMYWJlbD86IHN0cmluZ1xuICB0eXBlOiBDQi5TeW1ib2xUeXBlIHwgJ2ltcG9ydCcgfCAna2V5d29yZCdcbiAgcmVwbGFjZW1lbnRQcmVmaXg6IHN0cmluZ1xuICBkZXNjcmlwdGlvbj86IHN0cmluZ1xufVxuXG50eXBlIEdldFN5bWJvbHNDYWxsYmFjazxUPiA9IChidWZmZXI6IEF0b21UeXBlcy5UZXh0QnVmZmVyLCBwcmVmaXg6IHN0cmluZywgcG9zaXRpb246IEF0b21UeXBlcy5Qb2ludCkgPT4gUHJvbWlzZTxUW10+XG5cbmV4cG9ydCBjbGFzcyBTdWdnZXN0aW9uQnVpbGRlciB7XG4gIHByaXZhdGUgYnVmZmVyOiBBdG9tVHlwZXMuVGV4dEJ1ZmZlclxuICBwcml2YXRlIGxpbmVSYW5nZTogQXRvbVR5cGVzLlJhbmdlXG4gIHByaXZhdGUgbGluZTogc3RyaW5nXG4gIHByaXZhdGUgbXdsOiBudW1iZXJcbiAgY29uc3RydWN0b3IgKHByaXZhdGUgb3B0aW9uczogSU9wdGlvbnMsIHByaXZhdGUgYmFja2VuZDogQ0IuSUNvbXBsZXRpb25CYWNrZW5kKSB7XG4gICAgdGhpcy5idWZmZXIgPSB0aGlzLm9wdGlvbnMuZWRpdG9yLmdldEJ1ZmZlcigpXG4gICAgdGhpcy5saW5lUmFuZ2UgPSBuZXcgUmFuZ2UoXG4gICAgICBbdGhpcy5vcHRpb25zLmJ1ZmZlclBvc2l0aW9uLnJvdywgMF0sXG4gICAgICB0aGlzLm9wdGlvbnMuYnVmZmVyUG9zaXRpb25cbiAgICApXG4gICAgdGhpcy5saW5lID0gdGhpcy5idWZmZXIuZ2V0VGV4dEluUmFuZ2UodGhpcy5saW5lUmFuZ2UpXG4gICAgdGhpcy5td2wgPVxuICAgICAgdGhpcy5vcHRpb25zLmFjdGl2YXRlZE1hbnVhbGx5ID9cbiAgICAgICAgMFxuICAgICAgOlxuICAgICAgICBhdG9tLmNvbmZpZy5nZXQoJ2F1dG9jb21wbGV0ZS1wbHVzLm1pbmltdW1Xb3JkTGVuZ3RoJylcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRTdWdnZXN0aW9ucyAoKTogUHJvbWlzZTxJU3VnZ2VzdGlvbltdPiB7XG4gICAgaWYgKHRoaXMuaXNJbihpbnN0YW5jZVByZXByb2Nlc3NvclNjb3BlKSkge1xuICAgICAgcmV0dXJuIHRoaXMucHJlcHJvY2Vzc29yU3VnZ2VzdGlvbnMoaW5zdGFuY2VQcmFnbWFXb3JkcylcbiAgICB9IGVsc2UgaWYgKHRoaXMuaXNJbih0eXBlU2NvcGUpKSB7XG4gICAgICByZXR1cm4gdGhpcy5zeW1ib2xTdWdnZXN0aW9ucyh0aGlzLmJhY2tlbmQuZ2V0Q29tcGxldGlvbnNGb3JUeXBlLmJpbmQodGhpcy5iYWNrZW5kKSlcbiAgICB9IGVsc2UgaWYgKHRoaXMuaXNJbihtb2R1bGVTY29wZSkpIHtcbiAgICAgIHJldHVybiB0aGlzLm1vZHVsZVN1Z2dlc3Rpb25zKClcbiAgICB9IGVsc2UgaWYgKHRoaXMuaXNJbihleHBvcnRzU2NvcGUpKSB7XG4gICAgICByZXR1cm4gdGhpcy5zeW1ib2xTdWdnZXN0aW9ucyh0aGlzLmJhY2tlbmQuZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2xJbk1vZHVsZS5iaW5kKHRoaXMuYmFja2VuZCkpXG4gICAgfSBlbHNlIGlmICh0aGlzLmlzSW4ocHJlcHJvY2Vzc29yU2NvcGUpKSB7XG4gICAgICByZXR1cm4gdGhpcy5wcmVwcm9jZXNzb3JTdWdnZXN0aW9ucyhwcmFnbWFXb3JkcylcbiAgICAvLyBzaG91bGQgYmUgbGFzdCBhcyBsZWFzdCBzZXBjaWFsaXplZFxuICAgIH0gZWxzZSBpZiAodGhpcy5pc0luKHNvdXJjZVNjb3BlKSkge1xuICAgICAgaWYgKHRoaXMuZ2V0UHJlZml4KCkuc3RhcnRzV2l0aCgnXycpKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN5bWJvbFN1Z2dlc3Rpb25zKHRoaXMuYmFja2VuZC5nZXRDb21wbGV0aW9uc0ZvckhvbGUuYmluZCh0aGlzLmJhY2tlbmQpKVxuICAgICAgfSBlbHNlIGlmICh0aGlzLmdldFByZWZpeCgpID09PSAnJyAmJiB0aGlzLmdldFByZWZpeChvcGVyYXRvclJ4KSAhPT0gJycpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub3BlcmF0b3JTdWdnZXN0aW9ucygpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gdGhpcy5zeW1ib2xTdWdnZXN0aW9ucyh0aGlzLmJhY2tlbmQuZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2wuYmluZCh0aGlzLmJhY2tlbmQpKVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gW11cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGxpbmVTZWFyY2ggKHJ4OiBSZWdFeHAsIGlkeDogbnVtYmVyID0gMCkge1xuICAgIGNvbnN0IG1hdGNoID0gdGhpcy5saW5lLm1hdGNoKHJ4KVxuICAgIGlmIChtYXRjaCkge1xuICAgICAgcmV0dXJuIG1hdGNoXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBbJyddXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpc0luIChzY29wZTogc3RyaW5nW10pIHtcbiAgICByZXR1cm4gc2NvcGUuZXZlcnkoKHMxKSA9PiB0aGlzLm9wdGlvbnMuc2NvcGVEZXNjcmlwdG9yLmdldFNjb3Blc0FycmF5KCkuaW5jbHVkZXMoczEpKVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRQcmVmaXggKHJ4PzogUmVnRXhwKSB7XG4gICAgaWYgKCFyeCkgeyByeCA9IC9bXFx3LiddKyQvIH1cbiAgICByZXR1cm4gdGhpcy5saW5lU2VhcmNoKHJ4KVswXVxuICB9XG5cbiAgcHJpdmF0ZSBidWlsZFN5bWJvbFN1Z2dlc3Rpb24gKHM6IENCLklTeW1ib2wsIHByZWZpeDogc3RyaW5nKTogSVN1Z2dlc3Rpb24ge1xuICAgIHJldHVybiB7XG4gICAgICB0ZXh0OiBzLnFuYW1lID8gcy5xbmFtZSA6IHMubmFtZSxcbiAgICAgIHJpZ2h0TGFiZWw6IChzLm1vZHVsZSA/IHMubW9kdWxlLm5hbWUgOiB1bmRlZmluZWQpLFxuICAgICAgdHlwZTogcy5zeW1ib2xUeXBlLFxuICAgICAgcmVwbGFjZW1lbnRQcmVmaXg6IHByZWZpeCxcbiAgICAgIGRlc2NyaXB0aW9uOiBzLm5hbWUgKyAnIDo6ICcgKyBzLnR5cGVTaWduYXR1cmVcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkU2ltcGxlU3VnZ2VzdGlvbiAoXG4gICAgdHlwZTogJ2ltcG9ydCcgfCAna2V5d29yZCcsIHRleHQ6IHN0cmluZywgcHJlZml4OiBzdHJpbmcsIGxhYmVsPzogc3RyaW5nXG4gICk6IElTdWdnZXN0aW9uIHtcbiAgICByZXR1cm4ge1xuICAgICAgdGV4dCxcbiAgICAgIHR5cGUsXG4gICAgICByZXBsYWNlbWVudFByZWZpeDogcHJlZml4LFxuICAgICAgcmlnaHRMYWJlbDogbGFiZWxcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHByb2Nlc3NTdWdnZXN0aW9uczxUPiAoXG4gICAgZjogR2V0U3ltYm9sc0NhbGxiYWNrPFQ+LCByeDogUmVnRXhwIHwgdW5kZWZpbmVkLCBwOiAoczogVCwgcDogc3RyaW5nKSA9PiBJU3VnZ2VzdGlvblxuICApIHtcbiAgICBjb25zdCBwcmVmaXggPSB0aGlzLmdldFByZWZpeChyeClcbiAgICBpZiAocHJlZml4Lmxlbmd0aCA8IHRoaXMubXdsKSB7XG4gICAgICByZXR1cm4gW11cbiAgICB9XG4gICAgY29uc3Qgc3ltYm9scyA9IGF3YWl0IGYodGhpcy5idWZmZXIsIHByZWZpeCwgdGhpcy5vcHRpb25zLmJ1ZmZlclBvc2l0aW9uKVxuICAgIHJldHVybiBzeW1ib2xzLm1hcCgocykgPT4gcChzLCBwcmVmaXgpKVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzeW1ib2xTdWdnZXN0aW9ucyAoZjogR2V0U3ltYm9sc0NhbGxiYWNrPENCLklTeW1ib2w+LCByeD86IFJlZ0V4cCkge1xuICAgIHJldHVybiB0aGlzLnByb2Nlc3NTdWdnZXN0aW9ucyhmLCByeCwgdGhpcy5idWlsZFN5bWJvbFN1Z2dlc3Rpb24uYmluZCh0aGlzKSlcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgbW9kdWxlU3VnZ2VzdGlvbnMgKCkge1xuICAgIHJldHVybiB0aGlzLnByb2Nlc3NTdWdnZXN0aW9ucyh0aGlzLmJhY2tlbmQuZ2V0Q29tcGxldGlvbnNGb3JNb2R1bGUuYmluZCh0aGlzLmJhY2tlbmQpLCB1bmRlZmluZWQsIChzLCBwcmVmaXgpID0+XG4gICAgICB0aGlzLmJ1aWxkU2ltcGxlU3VnZ2VzdGlvbignaW1wb3J0JywgcywgcHJlZml4KSlcbiAgfVxuXG4gIHByaXZhdGUgcHJlcHJvY2Vzc29yU3VnZ2VzdGlvbnMgKHByYWdtYUxpc3Q6IHN0cmluZ1tdKSB7XG4gICAgbGV0IGY6IEdldFN5bWJvbHNDYWxsYmFjazxzdHJpbmc+XG4gICAgY29uc3Qga3dyeCA9IG5ldyBSZWdFeHAoYFxcXFxiKCR7cHJhZ21hTGlzdC5qb2luKCd8Jyl9KVxcXFxiYClcbiAgICBjb25zdCBrdyA9IHRoaXMubGluZVNlYXJjaChrd3J4KVswXVxuICAgIGxldCBsYWJlbCA9ICcnXG4gICAgbGV0IHJ4XG4gICAgc3dpdGNoIChmYWxzZSkge1xuICAgICAgY2FzZSBrdyAhPT0gJ09QVElPTlNfR0hDJzpcbiAgICAgICAgcnggPSAvW1xcdy1dKyQvXG4gICAgICAgIGxhYmVsID0gJ0dIQyBGbGFnJ1xuICAgICAgICBmID0gdGhpcy5iYWNrZW5kLmdldENvbXBsZXRpb25zRm9yQ29tcGlsZXJPcHRpb25zXG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlIGt3ICE9PSAnTEFOR1VBR0UnOlxuICAgICAgICBsYWJlbCA9ICdMYW5ndWFnZSdcbiAgICAgICAgZiA9IHRoaXMuYmFja2VuZC5nZXRDb21wbGV0aW9uc0Zvckxhbmd1YWdlUHJhZ21hc1xuICAgICAgICBicmVha1xuICAgICAgY2FzZSAhIWt3OlxuICAgICAgICBsYWJlbCA9ICdQcmFnbWEnXG4gICAgICAgIGYgPSBhc3luYyAoYiwgcCkgPT4gZmlsdGVyKHByYWdtYUxpc3QsIHApXG4gICAgICAgIGJyZWFrXG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gW11cbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcm9jZXNzU3VnZ2VzdGlvbnMoZiwgcngsIChzLCBwcmVmaXgpID0+XG4gICAgICB0aGlzLmJ1aWxkU2ltcGxlU3VnZ2VzdGlvbigna2V5d29yZCcsIHMsIHByZWZpeCwgbGFiZWwpKVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBvcGVyYXRvclN1Z2dlc3Rpb25zICgpIHtcbiAgICBjb25zdCBwcmVmaXhNYXRjaCA9IHRoaXMubGluZVNlYXJjaChvcGVyYXRvclJ4KVxuICAgIGlmICghcHJlZml4TWF0Y2gpIHsgcmV0dXJuIFtdIH1cbiAgICBjb25zdCBbbW9kLCBvcF0gPSBwcmVmaXhNYXRjaC5zbGljZSgxKVxuICAgIGlmIChwcmVmaXhNYXRjaFswXS5sZW5ndGggPCB0aGlzLm13bCkge1xuICAgICAgcmV0dXJuIFtdXG4gICAgfVxuICAgIGNvbnN0IG1rUU5hbWUgPSAoc3ltOiBDQi5JU3ltYm9sKSA9PiB7XG4gICAgICBjb25zdCB7bmFtZSwgcW5hbWV9ID0gc3ltXG4gICAgICBjb25zdCBuZXdRTmFtZSA9IHFuYW1lLnNsaWNlKDAsIC1uYW1lLmxlbmd0aCkgKyBuYW1lLnNsaWNlKDEsIC0xKVxuICAgICAgcmV0dXJuIHsuLi5zeW0sIHFuYW1lOiBuZXdRTmFtZX1cbiAgICB9XG4gICAgY29uc3Qgc3ltYm9scyA9XG4gICAgICBhd2FpdCB0aGlzLmJhY2tlbmQuZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2wodGhpcy5idWZmZXIsIGAke21vZCB8fCAnJ30oJHtvcH1gLCB0aGlzLm9wdGlvbnMuYnVmZmVyUG9zaXRpb24pXG4gICAgY29uc3QgbmV3U3ltcyA9XG4gICAgICBzeW1ib2xzXG4gICAgICAuZmlsdGVyKCh7c3ltYm9sVHlwZX0pID0+IHN5bWJvbFR5cGUgPT09ICdvcGVyYXRvcicpXG4gICAgICAubWFwKG1rUU5hbWUpXG4gICAgY29uc3QgYWxsU3ltcyA9IGZpbHRlcihzeW1ib2xzLmNvbmNhdChuZXdTeW1zKSwgcHJlZml4TWF0Y2hbMF0sIHtrZXk6ICdxbmFtZSd9KVxuICAgIHJldHVybiBhbGxTeW1zLm1hcCgocykgPT4gdGhpcy5idWlsZFN5bWJvbFN1Z2dlc3Rpb24ocywgcHJlZml4TWF0Y2hbMF0pKVxuICB9XG59XG4iXX0=