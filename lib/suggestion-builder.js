"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const fuzzaldrin_1 = require("fuzzaldrin");
const typeScope = ['meta.type-signature.haskell'];
const sourceScope = ['source.haskell'];
const moduleScope = ['meta.import.haskell', 'support.other.module.haskell'];
const preprocessorScope = ['meta.preprocessor.haskell'];
const instancePreprocessorScope = ['meta.declaration.instance.haskell', 'meta.preprocessor.haskell'];
const exportsScope = ['meta.import.haskell', 'meta.declaration.exports.haskell'];
const pragmaWords = [
    'LANGUAGE', 'OPTIONS_GHC', 'INCLUDE', 'WARNING', 'DEPRECATED', 'INLINE',
    'NOINLINE', 'ANN', 'LINE', 'RULES', 'SPECIALIZE', 'UNPACK', 'SOURCE'
];
const instancePragmaWords = [
    'INCOHERENT',
    'OVERLAPPABLE',
    'OVERLAPPING',
    'OVERLAPS'
];
class SuggestionBuilder {
    constructor(options, backend) {
        this.options = options;
        this.backend = backend;
        this.buffer = this.options.editor.getBuffer();
        this.lineRange = new atom_1.Range([this.options.bufferPosition.row, 0], this.options.bufferPosition);
        this.line = this.buffer.getTextInRange(this.lineRange);
        this.mwl =
            this.options.activatedManually ?
                0
                :
                    atom.config.get('autocomplete-plus.minimumWordLength');
    }
    getSuggestions() {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.isIn(instancePreprocessorScope)) {
                return this.preprocessorSuggestions(instancePragmaWords);
            }
            else if (this.isIn(typeScope)) {
                return this.symbolSuggestions(this.backend.getCompletionsForType.bind(this.backend));
            }
            else if (this.isIn(moduleScope)) {
                return this.moduleSuggestions();
            }
            else if (this.isIn(exportsScope)) {
                return this.symbolSuggestions(this.backend.getCompletionsForSymbolInModule.bind(this.backend));
            }
            else if (this.isIn(preprocessorScope)) {
                return this.preprocessorSuggestions(pragmaWords);
            }
            else if (this.isIn(sourceScope)) {
                if (this.getPrefix().startsWith('_')) {
                    if (atom.config.get('autocomplete-haskell.ingoreMinimumWordLengthForHoleCompletions')) {
                        this.mwl = 1;
                    }
                    return this.symbolSuggestions(this.backend.getCompletionsForHole.bind(this.backend));
                }
                else {
                    return this.symbolSuggestions(this.backend.getCompletionsForSymbol.bind(this.backend));
                }
            }
            else {
                return [];
            }
        });
    }
    lineSearch(rx, idx = 0) {
        const match = this.line.match(rx);
        if (match) {
            return match[0];
        }
        else {
            return '';
        }
    }
    isIn(scope) {
        return scope.every((s1) => this.options.scopeDescriptor.getScopesArray().includes(s1));
    }
    getPrefix(rx) {
        if (rx == null) {
            rx = /[\w.']+$/;
        }
        return this.lineSearch(rx);
    }
    buildSymbolSuggestion(s, prefix) {
        return {
            text: s.qname != null ? s.qname : s.name,
            rightLabel: (s.module != null ? s.module.name : undefined),
            type: s.symbolType,
            replacementPrefix: prefix,
            description: s.name + ' :: ' + s.typeSignature
        };
    }
    buildSimpleSuggestion(type, text, prefix, label) {
        return {
            text,
            type,
            replacementPrefix: prefix,
            rightLabel: label
        };
    }
    processSuggestions(f, rx, p) {
        return __awaiter(this, void 0, void 0, function* () {
            const prefix = this.getPrefix(rx);
            if (prefix.length < this.mwl) {
                return [];
            }
            const symbols = yield f(this.buffer, prefix, this.options.bufferPosition);
            return symbols.map((s) => p(s, prefix));
        });
    }
    symbolSuggestions(f) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.processSuggestions(f, undefined, this.buildSymbolSuggestion.bind(this));
        });
    }
    moduleSuggestions() {
        return __awaiter(this, void 0, void 0, function* () {
            return this.processSuggestions(this.backend.getCompletionsForModule.bind(this.backend), undefined, (s, prefix) => this.buildSimpleSuggestion('import', s, prefix));
        });
    }
    preprocessorSuggestions(pragmaList) {
        let f;
        const kwrx = new RegExp(`\\b(${pragmaList.join('|')})\\b`);
        const kw = this.lineSearch(kwrx);
        let label = '';
        let rx;
        switch (false) {
            case kw !== 'OPTIONS_GHC':
                rx = /[\w-]+$/;
                label = 'GHC Flag';
                f = this.backend.getCompletionsForCompilerOptions;
                break;
            case kw !== 'LANGUAGE':
                label = 'Language';
                f = this.backend.getCompletionsForLanguagePragmas;
                break;
            case !!kw:
                label = 'Pragma';
                f = (b, p) => __awaiter(this, void 0, void 0, function* () { return fuzzaldrin_1.filter(pragmaList, p); });
                break;
            default:
                return [];
        }
        return this.processSuggestions(f, rx, (s, prefix) => this.buildSimpleSuggestion('keyword', s, prefix, label));
    }
}
exports.SuggestionBuilder = SuggestionBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3VnZ2VzdGlvbi1idWlsZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3N1Z2dlc3Rpb24tYnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBU0EsK0JBQTBCO0FBQzFCLDJDQUFpQztBQUdqQyxNQUFNLFNBQVMsR0FBRyxDQUFDLDZCQUE2QixDQUFDLENBQUE7QUFDakQsTUFBTSxXQUFXLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO0FBQ3RDLE1BQU0sV0FBVyxHQUFHLENBQUMscUJBQXFCLEVBQUUsOEJBQThCLENBQUMsQ0FBQTtBQUMzRSxNQUFNLGlCQUFpQixHQUFHLENBQUMsMkJBQTJCLENBQUMsQ0FBQTtBQUN2RCxNQUFNLHlCQUF5QixHQUFHLENBQUMsbUNBQW1DLEVBQUUsMkJBQTJCLENBQUMsQ0FBQTtBQUNwRyxNQUFNLFlBQVksR0FBRyxDQUFDLHFCQUFxQixFQUFFLGtDQUFrQyxDQUFDLENBQUE7QUFFaEYsTUFBTSxXQUFXLEdBQUc7SUFDbEIsVUFBVSxFQUFFLGFBQWEsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxRQUFRO0lBQ3ZFLFVBQVUsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLFFBQVE7Q0FDckUsQ0FBQTtBQUVELE1BQU0sbUJBQW1CLEdBQUc7SUFDMUIsWUFBWTtJQUNaLGNBQWM7SUFDZCxhQUFhO0lBQ2IsVUFBVTtDQUNYLENBQUE7QUFtQkQ7SUFLRSxZQUFxQixPQUFpQixFQUFVLE9BQTJCO1FBQXRELFlBQU8sR0FBUCxPQUFPLENBQVU7UUFBVSxZQUFPLEdBQVAsT0FBTyxDQUFvQjtRQUN6RSxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFBO1FBQzdDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxZQUFLLENBQ3hCLENBQUMs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QUFDLEVBQUUsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUE7SUFDNUQsQ0FBQztDQUNGO0FBbklELDhDQW1JQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBkZWNhZmZlaW5hdGUgc3VnZ2VzdGlvbnM6XG4gKiBEUzEwMTogUmVtb3ZlIHVubmVjZXNzYXJ5IHVzZSBvZiBBcnJheS5mcm9tXG4gKiBEUzEwMjogUmVtb3ZlIHVubmVjZXNzYXJ5IGNvZGUgY3JlYXRlZCBiZWNhdXNlIG9mIGltcGxpY2l0IHJldHVybnNcbiAqIERTMTAzOiBSZXdyaXRlIGNvZGUgdG8gbm8gbG9uZ2VyIHVzZSBfX2d1YXJkX19cbiAqIERTMjA2OiBDb25zaWRlciByZXdvcmtpbmcgY2xhc3NlcyB0byBhdm9pZCBpbml0Q2xhc3NcbiAqIERTMjA3OiBDb25zaWRlciBzaG9ydGVyIHZhcmlhdGlvbnMgb2YgbnVsbCBjaGVja3NcbiAqIEZ1bGwgZG9jczogaHR0cHM6Ly9naXRodWIuY29tL2RlY2FmZmVpbmF0ZS9kZWNhZmZlaW5hdGUvYmxvYi9tYXN0ZXIvZG9jcy9zdWdnZXN0aW9ucy5tZFxuICovXG5pbXBvcnQge1JhbmdlfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHtmaWx0ZXJ9IGZyb20gJ2Z1enphbGRyaW4nXG5pbXBvcnQge0lDb21wbGV0aW9uQmFja2VuZCwgSVN5bWJvbCwgU3ltYm9sVHlwZX0gZnJvbSAnLi4vdHlwaW5ncy9jb21wbGV0aW9uLWJhY2tlbmQnXG5cbmNvbnN0IHR5cGVTY29wZSA9IFsnbWV0YS50eXBlLXNpZ25hdHVyZS5oYXNrZWxsJ11cbmNvbnN0IHNvdXJjZVNjb3BlID0gWydzb3VyY2UuaGFza2VsbCddXG5jb25zdCBtb2R1bGVTY29wZSA9IFsnbWV0YS5pbXBvcnQuaGFza2VsbCcsICdzdXBwb3J0Lm90aGVyLm1vZHVsZS5oYXNrZWxsJ11cbmNvbnN0IHByZXByb2Nlc3NvclNjb3BlID0gWydtZXRhLnByZXByb2Nlc3Nvci5oYXNrZWxsJ11cbmNvbnN0IGluc3RhbmNlUHJlcHJvY2Vzc29yU2NvcGUgPSBbJ21ldGEuZGVjbGFyYXRpb24uaW5zdGFuY2UuaGFza2VsbCcsICdtZXRhLnByZXByb2Nlc3Nvci5oYXNrZWxsJ11cbmNvbnN0IGV4cG9ydHNTY29wZSA9IFsnbWV0YS5pbXBvcnQuaGFza2VsbCcsICdtZXRhLmRlY2xhcmF0aW9uLmV4cG9ydHMuaGFza2VsbCddXG5cbmNvbnN0IHByYWdtYVdvcmRzID0gW1xuICAnTEFOR1VBR0UnLCAnT1BUSU9OU19HSEMnLCAnSU5DTFVERScsICdXQVJOSU5HJywgJ0RFUFJFQ0FURUQnLCAnSU5MSU5FJyxcbiAgJ05PSU5MSU5FJywgJ0FOTicsICdMSU5FJywgJ1JVTEVTJywgJ1NQRUNJQUxJWkUnLCAnVU5QQUNLJywgJ1NPVVJDRSdcbl1cblxuY29uc3QgaW5zdGFuY2VQcmFnbWFXb3JkcyA9IFtcbiAgJ0lOQ09IRVJFTlQnLFxuICAnT1ZFUkxBUFBBQkxFJyxcbiAgJ09WRVJMQVBQSU5HJyxcbiAgJ09WRVJMQVBTJ1xuXVxuXG5leHBvcnQgaW50ZXJmYWNlIElPcHRpb25zIHtcbiAgZWRpdG9yOiBBdG9tVHlwZXMuVGV4dEVkaXRvclxuICBidWZmZXJQb3NpdGlvbjogQXRvbVR5cGVzLlBvaW50XG4gIGFjdGl2YXRlZE1hbnVhbGx5OiBib29sZWFuXG4gIHNjb3BlRGVzY3JpcHRvcjogQXRvbVR5cGVzLlNjb3BlRGVzY3JpcHRvclxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElTdWdnZXN0aW9uIHtcbiAgdGV4dDogc3RyaW5nXG4gIHJpZ2h0TGFiZWw/OiBzdHJpbmdcbiAgdHlwZTogU3ltYm9sVHlwZSB8ICdpbXBvcnQnIHwgJ2tleXdvcmQnXG4gIHJlcGxhY2VtZW50UHJlZml4OiBzdHJpbmdcbiAgZGVzY3JpcHRpb24/OiBzdHJpbmdcbn1cblxudHlwZSBHZXRTeW1ib2xzQ2FsbGJhY2s8VD4gPSAoYnVmZmVyOiBBdG9tVHlwZXMuVGV4dEJ1ZmZlciwgcHJlZml4OiBzdHJpbmcsIHBvc2l0aW9uOiBBdG9tVHlwZXMuUG9pbnQpID0+IFByb21pc2U8VFtdPlxuXG5leHBvcnQgY2xhc3MgU3VnZ2VzdGlvbkJ1aWxkZXIge1xuICBwcml2YXRlIGJ1ZmZlcjogQXRvbVR5cGVzLlRleHRCdWZmZXJcbiAgcHJpdmF0ZSBsaW5lUmFuZ2U6IEF0b21UeXBlcy5SYW5nZVxuICBwcml2YXRlIGxpbmU6IHN0cmluZ1xuICBwcml2YXRlIG13bDogbnVtYmVyXG4gIGNvbnN0cnVjdG9yIChwcml2YXRlIG9wdGlvbnM6IElPcHRpb25zLCBwcml2YXRlIGJhY2tlbmQ6IElDb21wbGV0aW9uQmFja2VuZCkge1xuICAgIHRoaXMuYnVmZmVyID0gdGhpcy5vcHRpb25zLmVkaXRvci5nZXRCdWZmZXIoKVxuICAgIHRoaXMubGluZVJhbmdlID0gbmV3IFJhbmdlKFxuICAgICAgW3RoaXMub3B0aW9ucy5idWZmZXJQb3NpdGlvbi5yb3csIDBdLFxuICAgICAgdGhpcy5vcHRpb25zLmJ1ZmZlclBvc2l0aW9uXG4gICAgKVxuICAgIHRoaXMubGluZSA9IHRoaXMuYnVmZmVyLmdldFRleHRJblJhbmdlKHRoaXMubGluZVJhbmdlKVxuICAgIHRoaXMubXdsID1cbiAgICAgIHRoaXMub3B0aW9ucy5hY3RpdmF0ZWRNYW51YWxseSA/XG4gICAgICAgIDBcbiAgICAgIDpcbiAgICAgICAgYXRvbS5jb25maWcuZ2V0KCdhdXRvY29tcGxldGUtcGx1cy5taW5pbXVtV29yZExlbmd0aCcpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0U3VnZ2VzdGlvbnMgKCk6IFByb21pc2U8SVN1Z2dlc3Rpb25bXT4ge1xuICAgIGlmICh0aGlzLmlzSW4oaW5zdGFuY2VQcmVwcm9jZXNzb3JTY29wZSkpIHtcbiAgICAgIHJldHVybiB0aGlzLnByZXByb2Nlc3NvclN1Z2dlc3Rpb25zKGluc3RhbmNlUHJhZ21hV29yZHMpXG4gICAgfSBlbHNlIGlmICh0aGlzLmlzSW4odHlwZVNjb3BlKSkge1xuICAgICAgcmV0dXJuIHRoaXMuc3ltYm9sU3VnZ2VzdGlvbnModGhpcy5iYWNrZW5kLmdldENvbXBsZXRpb25zRm9yVHlwZS5iaW5kKHRoaXMuYmFja2VuZCkpXG4gICAgfSBlbHNlIGlmICh0aGlzLmlzSW4obW9kdWxlU2NvcGUpKSB7XG4gICAgICByZXR1cm4gdGhpcy5tb2R1bGVTdWdnZXN0aW9ucygpXG4gICAgfSBlbHNlIGlmICh0aGlzLmlzSW4oZXhwb3J0c1Njb3BlKSkge1xuICAgICAgcmV0dXJuIHRoaXMuc3ltYm9sU3VnZ2VzdGlvbnModGhpcy5iYWNrZW5kLmdldENvbXBsZXRpb25zRm9yU3ltYm9sSW5Nb2R1bGUuYmluZCh0aGlzLmJhY2tlbmQpKVxuICAgIH0gZWxzZSBpZiAodGhpcy5pc0luKHByZXByb2Nlc3NvclNjb3BlKSkge1xuICAgICAgcmV0dXJuIHRoaXMucHJlcHJvY2Vzc29yU3VnZ2VzdGlvbnMocHJhZ21hV29yZHMpXG4gICAgLy8gc2hvdWxkIGJlIGxhc3QgYXMgbGVhc3Qgc2VwY2lhbGl6ZWRcbiAgICB9IGVsc2UgaWYgKHRoaXMuaXNJbihzb3VyY2VTY29wZSkpIHtcbiAgICAgIGlmICh0aGlzLmdldFByZWZpeCgpLnN0YXJ0c1dpdGgoJ18nKSkge1xuICAgICAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdhdXRvY29tcGxldGUtaGFza2VsbC5pbmdvcmVNaW5pbXVtV29yZExlbmd0aEZvckhvbGVDb21wbGV0aW9ucycpKSB7XG4gICAgICAgICAgdGhpcy5td2wgPSAxXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuc3ltYm9sU3VnZ2VzdGlvbnModGhpcy5iYWNrZW5kLmdldENvbXBsZXRpb25zRm9ySG9sZS5iaW5kKHRoaXMuYmFja2VuZCkpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gdGhpcy5zeW1ib2xTdWdnZXN0aW9ucyh0aGlzLmJhY2tlbmQuZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2wuYmluZCh0aGlzLmJhY2tlbmQpKVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gW11cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGxpbmVTZWFyY2ggKHJ4OiBSZWdFeHAsIGlkeDogbnVtYmVyID0gMCkge1xuICAgIGNvbnN0IG1hdGNoID0gdGhpcy5saW5lLm1hdGNoKHJ4KVxuICAgIGlmIChtYXRjaCkge1xuICAgICAgcmV0dXJuIG1hdGNoWzBdXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiAnJ1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaXNJbiAoc2NvcGU6IHN0cmluZ1tdKSB7XG4gICAgcmV0dXJuIHNjb3BlLmV2ZXJ5KChzMSkgPT4gdGhpcy5vcHRpb25zLnNjb3BlRGVzY3JpcHRvci5nZXRTY29wZXNBcnJheSgpLmluY2x1ZGVzKHMxKSlcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UHJlZml4IChyeD86IFJlZ0V4cCkge1xuICAgIGlmIChyeCA9PSBudWxsKSB7IHJ4ID0gL1tcXHcuJ10rJC8gfVxuICAgIHJldHVybiB0aGlzLmxpbmVTZWFyY2gocngpXG4gIH1cblxuICBwcml2YXRlIGJ1aWxkU3ltYm9sU3VnZ2VzdGlvbiAoczogSVN5bWJvbCwgcHJlZml4OiBzdHJpbmcpOiBJU3VnZ2VzdGlvbiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRleHQ6IHMucW5hbWUgIT0gbnVsbCA/IHMucW5hbWUgOiBzLm5hbWUsXG4gICAgICByaWdodExhYmVsOiAocy5tb2R1bGUgIT0gbnVsbCA/IHMubW9kdWxlLm5hbWUgOiB1bmRlZmluZWQpLFxuICAgICAgdHlwZTogcy5zeW1ib2xUeXBlLFxuICAgICAgcmVwbGFjZW1lbnRQcmVmaXg6IHByZWZpeCxcbiAgICAgIGRlc2NyaXB0aW9uOiBzLm5hbWUgKyAnIDo6ICcgKyBzLnR5cGVTaWduYXR1cmVcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkU2ltcGxlU3VnZ2VzdGlvbiAoXG4gICAgdHlwZTogJ2ltcG9ydCcgfCAna2V5d29yZCcsIHRleHQ6IHN0cmluZywgcHJlZml4OiBzdHJpbmcsIGxhYmVsPzogc3RyaW5nXG4gICk6IElTdWdnZXN0aW9uIHtcbiAgICByZXR1cm4ge1xuICAgICAgdGV4dCxcbiAgICAgIHR5cGUsXG4gICAgICByZXBsYWNlbWVudFByZWZpeDogcHJlZml4LFxuICAgICAgcmlnaHRMYWJlbDogbGFiZWxcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHByb2Nlc3NTdWdnZXN0aW9uczxUPiAoXG4gICAgZjogR2V0U3ltYm9sc0NhbGxiYWNrPFQ+LCByeDogUmVnRXhwIHwgdW5kZWZpbmVkLCBwOiAoczogVCwgcDogc3RyaW5nKSA9PiBJU3VnZ2VzdGlvblxuICApIHtcbiAgICBjb25zdCBwcmVmaXggPSB0aGlzLmdldFByZWZpeChyeClcbiAgICBpZiAocHJlZml4Lmxlbmd0aCA8IHRoaXMubXdsKSB7XG4gICAgICByZXR1cm4gW11cbiAgICB9XG4gICAgY29uc3Qgc3ltYm9scyA9IGF3YWl0IGYodGhpcy5idWZmZXIsIHByZWZpeCwgdGhpcy5vcHRpb25zLmJ1ZmZlclBvc2l0aW9uKVxuICAgIHJldHVybiBzeW1ib2xzLm1hcCgocykgPT4gcChzLCBwcmVmaXgpKVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzeW1ib2xTdWdnZXN0aW9ucyAoZjogR2V0U3ltYm9sc0NhbGxiYWNrPElTeW1ib2w+KSB7XG4gICAgcmV0dXJuIHRoaXMucHJvY2Vzc1N1Z2dlc3Rpb25zKGYsIHVuZGVmaW5lZCwgdGhpcy5idWlsZFN5bWJvbFN1Z2dlc3Rpb24uYmluZCh0aGlzKSlcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgbW9kdWxlU3VnZ2VzdGlvbnMgKCkge1xuICAgIHJldHVybiB0aGlzLnByb2Nlc3NTdWdnZXN0aW9ucyh0aGlzLmJhY2tlbmQuZ2V0Q29tcGxldGlvbnNGb3JNb2R1bGUuYmluZCh0aGlzLmJhY2tlbmQpLCB1bmRlZmluZWQsIChzLCBwcmVmaXgpID0+XG4gICAgICB0aGlzLmJ1aWxkU2ltcGxlU3VnZ2VzdGlvbignaW1wb3J0JywgcywgcHJlZml4KSlcbiAgfVxuXG4gIHByaXZhdGUgcHJlcHJvY2Vzc29yU3VnZ2VzdGlvbnMgKHByYWdtYUxpc3Q6IHN0cmluZ1tdKSB7XG4gICAgbGV0IGY6IEdldFN5bWJvbHNDYWxsYmFjazxzdHJpbmc+XG4gICAgY29uc3Qga3dyeCA9IG5ldyBSZWdFeHAoYFxcXFxiKCR7cHJhZ21hTGlzdC5qb2luKCd8Jyl9KVxcXFxiYClcbiAgICBjb25zdCBrdyA9IHRoaXMubGluZVNlYXJjaChrd3J4KVxuICAgIGxldCBsYWJlbCA9ICcnXG4gICAgbGV0IHJ4XG4gICAgc3dpdGNoIChmYWxzZSkge1xuICAgICAgY2FzZSBrdyAhPT0gJ09QVElPTlNfR0hDJzpcbiAgICAgICAgcnggPSAvW1xcdy1dKyQvXG4gICAgICAgIGxhYmVsID0gJ0dIQyBGbGFnJ1xuICAgICAgICBmID0gdGhpcy5iYWNrZW5kLmdldENvbXBsZXRpb25zRm9yQ29tcGlsZXJPcHRpb25zXG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlIGt3ICE9PSAnTEFOR1VBR0UnOlxuICAgICAgICBsYWJlbCA9ICdMYW5ndWFnZSdcbiAgICAgICAgZiA9IHRoaXMuYmFja2VuZC5nZXRDb21wbGV0aW9uc0Zvckxhbmd1YWdlUHJhZ21hc1xuICAgICAgICBicmVha1xuICAgICAgY2FzZSAhIWt3OlxuICAgICAgICBsYWJlbCA9ICdQcmFnbWEnXG4gICAgICAgIGYgPSBhc3luYyAoYiwgcCkgPT4gZmlsdGVyKHByYWdtYUxpc3QsIHApXG4gICAgICAgIGJyZWFrXG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gW11cbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcm9jZXNzU3VnZ2VzdGlvbnMoZiwgcngsIChzLCBwcmVmaXgpID0+XG4gICAgICB0aGlzLmJ1aWxkU2ltcGxlU3VnZ2VzdGlvbigna2V5d29yZCcsIHMsIHByZWZpeCwgbGFiZWwpKVxuICB9XG59XG4iXX0=