"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const fuzzaldrin_1 = require("fuzzaldrin");
const typeScope = ['meta.type-signature.haskell'];
const sourceScope = ['source.haskell'];
const moduleScope = ['meta.import.haskell', 'support.other.module.haskell'];
const preprocessorScope = ['meta.preprocessor.haskell'];
const instancePreprocessorScope = ['meta.declaration.instance.haskell', 'meta.preprocessor.haskell'];
const exportsScope = ['meta.import.haskell', 'meta.declaration.exports.haskell'];
const pragmaWords = [
    'LANGUAGE', 'OPTIONS_GHC', 'INCLUDE', 'WARNING', 'DEPRECATED', 'INLINE',
    'NOINLINE', 'ANN', 'LINE', 'RULES', 'SPECIALIZE', 'UNPACK', 'SOURCE',
];
const instancePragmaWords = [
    'INCOHERENT',
    'OVERLAPPABLE',
    'OVERLAPPING',
    'OVERLAPS',
];
const opertator_regex_1 = require("./opertator-regex");
class SuggestionBuilder {
    constructor(options, backend) {
        this.options = options;
        this.backend = backend;
        this.buffer = this.options.editor.getBuffer();
        this.lineRange = new atom_1.Range([this.options.bufferPosition.row, 0], this.options.bufferPosition);
        this.line = this.buffer.getTextInRange(this.lineRange);
        this.mwl =
            this.options.activatedManually ?
                0
                :
                    atom.config.get('autocomplete-plus.minimumWordLength');
    }
    getSuggestions() {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.isIn(instancePreprocessorScope)) {
                return this.preprocessorSuggestions(instancePragmaWords);
            }
            else if (this.isIn(typeScope)) {
                return this.symbolSuggestions(this.backend.getCompletionsForType.bind(this.backend));
            }
            else if (this.isIn(moduleScope)) {
                return this.moduleSuggestions();
            }
            else if (this.isIn(exportsScope)) {
                return this.symbolSuggestions(this.backend.getCompletionsForSymbolInModule.bind(this.backend));
            }
            else if (this.isIn(preprocessorScope)) {
                return this.preprocessorSuggestions(pragmaWords);
            }
            else if (this.isIn(sourceScope)) {
                if (this.getPrefix().startsWith('_')) {
                    return this.symbolSuggestions(this.backend.getCompletionsForHole.bind(this.backend));
                }
                else if (this.getPrefix() === '' && this.getPrefix(opertator_regex_1.operatorRx) !== '') {
                    return this.operatorSuggestions();
                }
                else {
                    return this.symbolSuggestions(this.backend.getCompletionsForSymbol.bind(this.backend));
                }
            }
            else {
                return [];
            }
        });
    }
    lineSearch(rx, idx = 0) {
        const match = this.line.match(rx);
        if (match) {
            return match;
        }
        else {
            return [''];
        }
    }
    isIn(scope) {
        return scope.every((s1) => this.options.scopeDescriptor.getScopesArray().includes(s1));
    }
    getPrefix(rx) {
        if (!rx) {
            rx = opertator_regex_1.identRx;
        }
        return this.lineSearch(rx)[0];
    }
    buildSymbolSuggestion(s, prefix) {
        return {
            text: s.qname ? s.qname : s.name,
            rightLabel: (s.module ? s.module.name : undefined),
            type: s.symbolType,
            replacementPrefix: prefix,
            description: this.nameFix(s) + ' :: ' + s.typeSignature,
        };
    }
    nameFix(s) {
        if (s.symbolType === 'operator') {
            return `(${s.name})`;
        }
        else {
            return s.name;
        }
    }
    buildSimpleSuggestion(type, text, prefix, label) {
        return {
            text,
            type,
            replacementPrefix: prefix,
            rightLabel: label,
        };
    }
    processSuggestions(f, rx, p) {
        return __awaiter(this, void 0, void 0, function* () {
            const prefix = this.getPrefix(rx);
            if (prefix.length < this.mwl) {
                return [];
            }
            const symbols = yield f(this.buffer, prefix, this.options.bufferPosition);
            return symbols.map((s) => p(s, prefix));
        });
    }
    symbolSuggestions(f, rx) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.processSuggestions(f, rx, this.buildSymbolSuggestion.bind(this));
        });
    }
    moduleSuggestions() {
        return __awaiter(this, void 0, void 0, function* () {
            return this.processSuggestions(this.backend.getCompletionsForModule.bind(this.backend), undefined, (s, prefix) => this.buildSimpleSuggestion('import', s, prefix));
        });
    }
    preprocessorSuggestions(pragmaList) {
        let f;
        const kwrx = new RegExp(`\\b(${pragmaList.join('|')})\\b`);
        const kw = this.lineSearch(kwrx)[0];
        let label = '';
        let rx;
        switch (false) {
            case kw !== 'OPTIONS_GHC':
                rx = /[\w-]+$/;
                label = 'GHC Flag';
                f = this.backend.getCompletionsForCompilerOptions;
                break;
            case kw !== 'LANGUAGE':
                label = 'Language';
                f = this.backend.getCompletionsForLanguagePragmas;
                break;
            case !!kw:
                label = 'Pragma';
                f = (b, p) => __awaiter(this, void 0, void 0, function* () { return fuzzaldrin_1.filter(pragmaList, p); });
                break;
            default:
                return [];
        }
        return this.processSuggestions(f, rx, (s, prefix) => this.buildSimpleSuggestion('keyword', s, prefix, label));
    }
    operatorSuggestions() {
        return __awaiter(this, void 0, void 0, function* () {
            const prefixMatch = this.lineSearch(opertator_regex_1.operatorRx);
            if (!prefixMatch) {
                return [];
            }
            const [mod, op] = prefixMatch.slice(1);
            if (prefixMatch[0].length < this.mwl) {
                return [];
            }
            const symbols = yield this.backend.getCompletionsForSymbol(this.buffer, `${mod || ''}${op}`, this.options.bufferPosition);
            const newSyms = symbols
                .filter(({ symbolType }) => symbolType === 'operator');
            const allSyms = fuzzaldrin_1.filter(newSyms, prefixMatch[0], { key: 'qname' });
            return allSyms.map((s) => this.buildSymbolSuggestion(s, prefixMatch[0]));
        });
    }
}
exports.SuggestionBuilder = SuggestionBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3VnZ2VzdGlvbi1idWlsZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3N1Z2dlc3Rpb24tYnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsK0JBQTRCO0FBQzVCLDJDQUFtQztBQUduQyxNQUFNLFNBQVMsR0FBRyxDQUFDLDZCQUE2QixDQUFDLENBQUE7QUFDakQsTUFBTSxXQUFXLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO0FBQ3RDLE1BQU0sV0FBVyxHQUFHLENBQUMscUJBQXFCLEVBQUUsOEJBQThCLENBQUMsQ0FBQTtBQUMzRSxNQUFNLGlCQUFpQixHQUFHLENBQUMsMkJBQTJCLENBQUMsQ0FBQTtBQUN2RCxNQUFNLHlCQUF5QixHQUFHLENBQUMsbUNBQW1DLEVBQUUsMkJBQTJCLENBQUMsQ0FBQTtBQUNwRyxNQUFNLFlBQVksR0FBRyxDQUFDLHFCQUFxQixFQUFFLGtDQUFrQyxDQUFDLENBQUE7QUFFaEYsTUFBTSxXQUFXLEdBQUc7SUFDbEIsVUFBVSxFQUFFLGFBQWEsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxRQUFRO0lBQ3ZFLFVBQVUsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLFFBQVE7Q0FDckUsQ0FBQTtBQUVELE1BQU0sbUJBQW1CLEdBQUc7SUFDMUIsWUFBWTtJQUNaLGNBQWM7SUFDZCxhQUFhO0lBQ2IsVUFBVTtDQUNYLENBQUE7QUFFRCx1REFBdUQ7QUFtQnZEO0lBS0UsWUFBb0IsT0FBaUIsRUFBVSxPQUE4QjtRQUF6RCxZQUFPLEdBQVAsT0FBTyxDQUFVO1FBQVUsWUFBTyxHQUFQLE9BQU8sQ0FBdUI7UUFDM0UsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQTtRQUM3QyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksWUFB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LElBQUksRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUE7WUFDM0csTUFBTSxPQUFPLEdBQ1gsT0FBTztpQkFDSixNQUFNLENBQUMsQ0FBQyxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxVQUFVLEtBQUssVUFBVSxDQUFDLENBQUE7WUFDMUQsTUFBTSxPQUFPLEdBQUcsbUJBQU0sQ0FBQyxPQUFPLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUE7WUFDakUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUMxRSxDQUFDO0tBQUE7Q0FDRjtBQTFKRCw4Q0EwSkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSYW5nZSB9IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBmaWx0ZXIgfSBmcm9tICdmdXp6YWxkcmluJ1xuaW1wb3J0IENCID0gVVBJLkNvbXBsZXRpb25CYWNrZW5kXG5cbmNvbnN0IHR5cGVTY29wZSA9IFsnbWV0YS50eXBlLXNpZ25hdHVyZS5oYXNrZWxsJ11cbmNvbnN0IHNvdXJjZVNjb3BlID0gWydzb3VyY2UuaGFza2VsbCddXG5jb25zdCBtb2R1bGVTY29wZSA9IFsnbWV0YS5pbXBvcnQuaGFza2VsbCcsICdzdXBwb3J0Lm90aGVyLm1vZHVsZS5oYXNrZWxsJ11cbmNvbnN0IHByZXByb2Nlc3NvclNjb3BlID0gWydtZXRhLnByZXByb2Nlc3Nvci5oYXNrZWxsJ11cbmNvbnN0IGluc3RhbmNlUHJlcHJvY2Vzc29yU2NvcGUgPSBbJ21ldGEuZGVjbGFyYXRpb24uaW5zdGFuY2UuaGFza2VsbCcsICdtZXRhLnByZXByb2Nlc3Nvci5oYXNrZWxsJ11cbmNvbnN0IGV4cG9ydHNTY29wZSA9IFsnbWV0YS5pbXBvcnQuaGFza2VsbCcsICdtZXRhLmRlY2xhcmF0aW9uLmV4cG9ydHMuaGFza2VsbCddXG5cbmNvbnN0IHByYWdtYVdvcmRzID0gW1xuICAnTEFOR1VBR0UnLCAnT1BUSU9OU19HSEMnLCAnSU5DTFVERScsICdXQVJOSU5HJywgJ0RFUFJFQ0FURUQnLCAnSU5MSU5FJyxcbiAgJ05PSU5MSU5FJywgJ0FOTicsICdMSU5FJywgJ1JVTEVTJywgJ1NQRUNJQUxJWkUnLCAnVU5QQUNLJywgJ1NPVVJDRScsXG5dXG5cbmNvbnN0IGluc3RhbmNlUHJhZ21hV29yZHMgPSBbXG4gICdJTkNPSEVSRU5UJyxcbiAgJ09WRVJMQVBQQUJMRScsXG4gICdPVkVSTEFQUElORycsXG4gICdPVkVSTEFQUycsXG5dXG5cbmltcG9ydCB7IG9wZXJhdG9yUngsIGlkZW50UnggfSBmcm9tICcuL29wZXJ0YXRvci1yZWdleCdcblxuZXhwb3J0IGludGVyZmFjZSBJT3B0aW9ucyB7XG4gIGVkaXRvcjogQXRvbVR5cGVzLlRleHRFZGl0b3JcbiAgYnVmZmVyUG9zaXRpb246IEF0b21UeXBlcy5Qb2ludFxuICBhY3RpdmF0ZWRNYW51YWxseTogYm9vbGVhblxuICBzY29wZURlc2NyaXB0b3I6IEF0b21UeXBlcy5TY29wZURlc2NyaXB0b3Jcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJU3VnZ2VzdGlvbiB7XG4gIHRleHQ6IHN0cmluZ1xuICByaWdodExhYmVsPzogc3RyaW5nXG4gIHR5cGU6IENCLlN5bWJvbFR5cGUgfCAnaW1wb3J0JyB8ICdrZXl3b3JkJ1xuICByZXBsYWNlbWVudFByZWZpeDogc3RyaW5nXG4gIGRlc2NyaXB0aW9uPzogc3RyaW5nXG59XG5cbnR5cGUgR2V0U3ltYm9sc0NhbGxiYWNrPFQ+ID0gKGJ1ZmZlcjogQXRvbVR5cGVzLlRleHRCdWZmZXIsIHByZWZpeDogc3RyaW5nLCBwb3NpdGlvbjogQXRvbVR5cGVzLlBvaW50KSA9PiBQcm9taXNlPFRbXT5cblxuZXhwb3J0IGNsYXNzIFN1Z2dlc3Rpb25CdWlsZGVyIHtcbiAgcHJpdmF0ZSBidWZmZXI6IEF0b21UeXBlcy5UZXh0QnVmZmVyXG4gIHByaXZhdGUgbGluZVJhbmdlOiBBdG9tVHlwZXMuUmFuZ2VcbiAgcHJpdmF0ZSBsaW5lOiBzdHJpbmdcbiAgcHJpdmF0ZSBtd2w6IG51bWJlclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG9wdGlvbnM6IElPcHRpb25zLCBwcml2YXRlIGJhY2tlbmQ6IENCLklDb21wbGV0aW9uQmFja2VuZCkge1xuICAgIHRoaXMuYnVmZmVyID0gdGhpcy5vcHRpb25zLmVkaXRvci5nZXRCdWZmZXIoKVxuICAgIHRoaXMubGluZVJhbmdlID0gbmV3IFJhbmdlKFxuICAgICAgW3RoaXMub3B0aW9ucy5idWZmZXJQb3NpdGlvbi5yb3csIDBdLFxuICAgICAgdGhpcy5vcHRpb25zLmJ1ZmZlclBvc2l0aW9uLFxuICAgIClcbiAgICB0aGlzLmxpbmUgPSB0aGlzLmJ1ZmZlci5nZXRUZXh0SW5SYW5nZSh0aGlzLmxpbmVSYW5nZSlcbiAgICB0aGlzLm13bCA9XG4gICAgICB0aGlzLm9wdGlvbnMuYWN0aXZhdGVkTWFudWFsbHkgP1xuICAgICAgICAwXG4gICAgICAgIDpcbiAgICAgICAgYXRvbS5jb25maWcuZ2V0KCdhdXRvY29tcGxldGUtcGx1cy5taW5pbXVtV29yZExlbmd0aCcpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0U3VnZ2VzdGlvbnMoKTogUHJvbWlzZTxJU3VnZ2VzdGlvbltdPiB7XG4gICAgaWYgKHRoaXMuaXNJbihpbnN0YW5jZVByZXByb2Nlc3NvclNjb3BlKSkge1xuICAgICAgcmV0dXJuIHRoaXMucHJlcHJvY2Vzc29yU3VnZ2VzdGlvbnMoaW5zdGFuY2VQcmFnbWFXb3JkcylcbiAgICB9IGVsc2UgaWYgKHRoaXMuaXNJbih0eXBlU2NvcGUpKSB7XG4gICAgICByZXR1cm4gdGhpcy5zeW1ib2xTdWdnZXN0aW9ucyh0aGlzLmJhY2tlbmQuZ2V0Q29tcGxldGlvbnNGb3JUeXBlLmJpbmQodGhpcy5iYWNrZW5kKSlcbiAgICB9IGVsc2UgaWYgKHRoaXMuaXNJbihtb2R1bGVTY29wZSkpIHtcbiAgICAgIHJldHVybiB0aGlzLm1vZHVsZVN1Z2dlc3Rpb25zKClcbiAgICB9IGVsc2UgaWYgKHRoaXMuaXNJbihleHBvcnRzU2NvcGUpKSB7XG4gICAgICByZXR1cm4gdGhpcy5zeW1ib2xTdWdnZXN0aW9ucyh0aGlzLmJhY2tlbmQuZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2xJbk1vZHVsZS5iaW5kKHRoaXMuYmFja2VuZCkpXG4gICAgfSBlbHNlIGlmICh0aGlzLmlzSW4ocHJlcHJvY2Vzc29yU2NvcGUpKSB7XG4gICAgICByZXR1cm4gdGhpcy5wcmVwcm9jZXNzb3JTdWdnZXN0aW9ucyhwcmFnbWFXb3JkcylcbiAgICAgIC8vIHNob3VsZCBiZSBsYXN0IGFzIGxlYXN0IHNlcGNpYWxpemVkXG4gICAgfSBlbHNlIGlmICh0aGlzLmlzSW4oc291cmNlU2NvcGUpKSB7XG4gICAgICBpZiAodGhpcy5nZXRQcmVmaXgoKS5zdGFydHNXaXRoKCdfJykpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3ltYm9sU3VnZ2VzdGlvbnModGhpcy5iYWNrZW5kLmdldENvbXBsZXRpb25zRm9ySG9sZS5iaW5kKHRoaXMuYmFja2VuZCkpXG4gICAgICB9IGVsc2UgaWYgKHRoaXMuZ2V0UHJlZml4KCkgPT09ICcnICYmIHRoaXMuZ2V0UHJlZml4KG9wZXJhdG9yUngpICE9PSAnJykge1xuICAgICAgICByZXR1cm4gdGhpcy5vcGVyYXRvclN1Z2dlc3Rpb25zKClcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN5bWJvbFN1Z2dlc3Rpb25zKHRoaXMuYmFja2VuZC5nZXRDb21wbGV0aW9uc0ZvclN5bWJvbC5iaW5kKHRoaXMuYmFja2VuZCkpXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBbXVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgbGluZVNlYXJjaChyeDogUmVnRXhwLCBpZHg6IG51bWJlciA9IDApIHtcbiAgICBjb25zdCBtYXRjaCA9IHRoaXMubGluZS5tYXRjaChyeClcbiAgICBpZiAobWF0Y2gpIHtcbiAgICAgIHJldHVybiBtYXRjaFxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gWycnXVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaXNJbihzY29wZTogc3RyaW5nW10pIHtcbiAgICByZXR1cm4gc2NvcGUuZXZlcnkoKHMxKSA9PiB0aGlzLm9wdGlvbnMuc2NvcGVEZXNjcmlwdG9yLmdldFNjb3Blc0FycmF5KCkuaW5jbHVkZXMoczEpKVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRQcmVmaXgocng/OiBSZWdFeHApIHtcbiAgICBpZiAoIXJ4KSB7IHJ4ID0gaWRlbnRSeCB9XG4gICAgcmV0dXJuIHRoaXMubGluZVNlYXJjaChyeClbMF1cbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRTeW1ib2xTdWdnZXN0aW9uKHM6IENCLklTeW1ib2wsIHByZWZpeDogc3RyaW5nKTogSVN1Z2dlc3Rpb24ge1xuICAgIHJldHVybiB7XG4gICAgICB0ZXh0OiBzLnFuYW1lID8gcy5xbmFtZSA6IHMubmFtZSxcbiAgICAgIHJpZ2h0TGFiZWw6IChzLm1vZHVsZSA/IHMubW9kdWxlLm5hbWUgOiB1bmRlZmluZWQpLFxuICAgICAgdHlwZTogcy5zeW1ib2xUeXBlLFxuICAgICAgcmVwbGFjZW1lbnRQcmVmaXg6IHByZWZpeCxcbiAgICAgIGRlc2NyaXB0aW9uOiB0aGlzLm5hbWVGaXgocykgKyAnIDo6ICcgKyBzLnR5cGVTaWduYXR1cmUsXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBuYW1lRml4KHM6IENCLklTeW1ib2wpIHtcbiAgICBpZiAocy5zeW1ib2xUeXBlID09PSAnb3BlcmF0b3InKSB7XG4gICAgICByZXR1cm4gYCgke3MubmFtZX0pYFxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gcy5uYW1lXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBidWlsZFNpbXBsZVN1Z2dlc3Rpb24oXG4gICAgdHlwZTogJ2ltcG9ydCcgfCAna2V5d29yZCcsIHRleHQ6IHN0cmluZywgcHJlZml4OiBzdHJpbmcsIGxhYmVsPzogc3RyaW5nLFxuICApOiBJU3VnZ2VzdGlvbiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRleHQsXG4gICAgICB0eXBlLFxuICAgICAgcmVwbGFjZW1lbnRQcmVmaXg6IHByZWZpeCxcbiAgICAgIHJpZ2h0TGFiZWw6IGxhYmVsLFxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcHJvY2Vzc1N1Z2dlc3Rpb25zPFQ+KFxuICAgIGY6IEdldFN5bWJvbHNDYWxsYmFjazxUPiwgcng6IFJlZ0V4cCB8IHVuZGVmaW5lZCwgcDogKHM6IFQsIHA6IHN0cmluZykgPT4gSVN1Z2dlc3Rpb24sXG4gICkge1xuICAgIGNvbnN0IHByZWZpeCA9IHRoaXMuZ2V0UHJlZml4KHJ4KVxuICAgIGlmIChwcmVmaXgubGVuZ3RoIDwgdGhpcy5td2wpIHtcbiAgICAgIHJldHVybiBbXVxuICAgIH1cbiAgICBjb25zdCBzeW1ib2xzID0gYXdhaXQgZih0aGlzLmJ1ZmZlciwgcHJlZml4LCB0aGlzLm9wdGlvbnMuYnVmZmVyUG9zaXRpb24pXG4gICAgcmV0dXJuIHN5bWJvbHMubWFwKChzKSA9PiBwKHMsIHByZWZpeCkpXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHN5bWJvbFN1Z2dlc3Rpb25zKGY6IEdldFN5bWJvbHNDYWxsYmFjazxDQi5JU3ltYm9sPiwgcng/OiBSZWdFeHApIHtcbiAgICByZXR1cm4gdGhpcy5wcm9jZXNzU3VnZ2VzdGlvbnMoZiwgcngsIHRoaXMuYnVpbGRTeW1ib2xTdWdnZXN0aW9uLmJpbmQodGhpcykpXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIG1vZHVsZVN1Z2dlc3Rpb25zKCkge1xuICAgIHJldHVybiB0aGlzLnByb2Nlc3NTdWdnZXN0aW9ucyh0aGlzLmJhY2tlbmQuZ2V0Q29tcGxldGlvbnNGb3JNb2R1bGUuYmluZCh0aGlzLmJhY2tlbmQpLCB1bmRlZmluZWQsIChzLCBwcmVmaXgpID0+XG4gICAgICB0aGlzLmJ1aWxkU2ltcGxlU3VnZ2VzdGlvbignaW1wb3J0JywgcywgcHJlZml4KSlcbiAgfVxuXG4gIHByaXZhdGUgcHJlcHJvY2Vzc29yU3VnZ2VzdGlvbnMocHJhZ21hTGlzdDogc3RyaW5nW10pIHtcbiAgICBsZXQgZjogR2V0U3ltYm9sc0NhbGxiYWNrPHN0cmluZz5cbiAgICBjb25zdCBrd3J4ID0gbmV3IFJlZ0V4cChgXFxcXGIoJHtwcmFnbWFMaXN0LmpvaW4oJ3wnKX0pXFxcXGJgKVxuICAgIGNvbnN0IGt3ID0gdGhpcy5saW5lU2VhcmNoKGt3cngpWzBdXG4gICAgbGV0IGxhYmVsID0gJydcbiAgICBsZXQgcnhcbiAgICBzd2l0Y2ggKGZhbHNlKSB7XG4gICAgICBjYXNlIGt3ICE9PSAnT1BUSU9OU19HSEMnOlxuICAgICAgICByeCA9IC9bXFx3LV0rJC9cbiAgICAgICAgbGFiZWwgPSAnR0hDIEZsYWcnXG4gICAgICAgIGYgPSB0aGlzLmJhY2tlbmQuZ2V0Q29tcGxldGlvbnNGb3JDb21waWxlck9wdGlvbnNcbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2Uga3cgIT09ICdMQU5HVUFHRSc6XG4gICAgICAgIGxhYmVsID0gJ0xhbmd1YWdlJ1xuICAgICAgICBmID0gdGhpcy5iYWNrZW5kLmdldENvbXBsZXRpb25zRm9yTGFuZ3VhZ2VQcmFnbWFzXG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlICEha3c6XG4gICAgICAgIGxhYmVsID0gJ1ByYWdtYSdcbiAgICAgICAgZiA9IGFzeW5jIChiLCBwKSA9PiBmaWx0ZXIocHJhZ21hTGlzdCwgcClcbiAgICAgICAgYnJlYWtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiBbXVxuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnByb2Nlc3NTdWdnZXN0aW9ucyhmLCByeCwgKHMsIHByZWZpeCkgPT5cbiAgICAgIHRoaXMuYnVpbGRTaW1wbGVTdWdnZXN0aW9uKCdrZXl3b3JkJywgcywgcHJlZml4LCBsYWJlbCkpXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIG9wZXJhdG9yU3VnZ2VzdGlvbnMoKSB7XG4gICAgY29uc3QgcHJlZml4TWF0Y2ggPSB0aGlzLmxpbmVTZWFyY2gob3BlcmF0b3JSeClcbiAgICBpZiAoIXByZWZpeE1hdGNoKSB7IHJldHVybiBbXSB9XG4gICAgY29uc3QgW21vZCwgb3BdID0gcHJlZml4TWF0Y2guc2xpY2UoMSlcbiAgICBpZiAocHJlZml4TWF0Y2hbMF0ubGVuZ3RoIDwgdGhpcy5td2wpIHtcbiAgICAgIHJldHVybiBbXVxuICAgIH1cbiAgICBjb25zdCBzeW1ib2xzID1cbiAgICAgIGF3YWl0IHRoaXMuYmFja2VuZC5nZXRDb21wbGV0aW9uc0ZvclN5bWJvbCh0aGlzLmJ1ZmZlciwgYCR7bW9kIHx8ICcnfSR7b3B9YCwgdGhpcy5vcHRpb25zLmJ1ZmZlclBvc2l0aW9uKVxuICAgIGNvbnN0IG5ld1N5bXMgPVxuICAgICAgc3ltYm9sc1xuICAgICAgICAuZmlsdGVyKCh7IHN5bWJvbFR5cGUgfSkgPT4gc3ltYm9sVHlwZSA9PT0gJ29wZXJhdG9yJylcbiAgICBjb25zdCBhbGxTeW1zID0gZmlsdGVyKG5ld1N5bXMsIHByZWZpeE1hdGNoWzBdLCB7IGtleTogJ3FuYW1lJyB9KVxuICAgIHJldHVybiBhbGxTeW1zLm1hcCgocykgPT4gdGhpcy5idWlsZFN5bWJvbFN1Z2dlc3Rpb24ocywgcHJlZml4TWF0Y2hbMF0pKVxuICB9XG59XG4iXX0=